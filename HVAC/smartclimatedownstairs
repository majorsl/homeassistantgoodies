alias: "[Smart Climate] Control - Downstairs"
description: >
  Adaptive climate automation for Ecobee downstairs: occupancy, presence, sleep
  window, outdoor temp, manual override, and mode booleans.
triggers:
  - entity_id:
      - binary_sensor.downstairs_motion_sensors
    trigger: state
  - trigger: time_pattern
    hours: /1
  - trigger: state
    entity_id:
      - binary_sensor.basementwindowsensors
    for:
      hours: 0
      minutes: 3
      seconds: 0
    from: "off"
    to: "on"
  - trigger: state
    entity_id:
      - binary_sensor.basementwindowsensors
    for:
      hours: 0
      minutes: 1
      seconds: 15
    from: "on"
    to: "off"
  - trigger: state
    entity_id:
      - group.presence_all_home
  - trigger: state
    entity_id:
      - binary_sensor.entry_pir_sensor_home_security_motion_detected
  - trigger: state
    entity_id:
      - binary_sensor.office_motion_sensor_occupancy
  - trigger: state
    entity_id:
      - input_boolean.climate_downstairs_manual_override
    to: "off"
    for:
      hours: 0
      minutes: 0
      seconds: 10
conditions:
  - condition: state
    entity_id: input_boolean.climate_downstairs_manual_override
    state: "off"
actions:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ not door_open }}"
        sequence:
          - variables:
              hvac_mode: |-
                {{ 'heat' if outdoor_temp <= 60 else
                   'cool' if outdoor_temp >= 70 else
                   'heat_cool' }}
          - target:
              entity_id: input_boolean.climate_downstairs_recently_changed
            action: input_boolean.turn_on
          - target:
              entity_id: "{{ climate_entity }}"
            data:
              hvac_mode: "{{ hvac_mode }}"
            action: climate.set_hvac_mode
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ door_open }}"
        sequence:
          - target:
              entity_id: input_boolean.climate_downstairs_recently_changed
            action: input_boolean.turn_on
          - target:
              entity_id: "{{ climate_entity }}"
            data:
              hvac_mode: "off"
            action: climate.set_hvac_mode
          - target:
              entity_id:
                - input_boolean.climate_downstairs_home
                - input_boolean.climate_downstairs_away
                - input_boolean.climate_downstairs_sleep
            action: input_boolean.turn_off
      - conditions:
          - condition: template
            value_template: "{{ is_state('group.presence_all_home', 'home') }}"
        sequence:
          - variables:
              occupied_any: "{{ is_state('binary_sensor.downstairs_motion_sensors', 'on') }}"
              heat: |-
                {% if in_sleep_window %}
                  {{ setpoints.sleep.heat + adjust }}
                {% else %}
                  {% if occupied_any %}
                    {{ setpoints.home.heat + adjust }}
                  {% else %}
                    {{ setpoints.home.heat - 3 + adjust }}
                  {% endif %}
                {% endif %}
              cool: |-
                {% if in_sleep_window %}
                  {{ setpoints.sleep.cool + adjust }}
                {% else %}
                  {% if occupied_any %}
                    {{ setpoints.home.cool + adjust }}
                  {% else %}
                    {{ setpoints.home.cool + 3 + adjust }}
                  {% endif %}
                {% endif %}
              current_mode: "{{ states('climate.downstairs_2') }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ current_mode in ['auto', 'heat_cool'] }}"
                sequence:
                  - target:
                      entity_id: input_boolean.climate_downstairs_recently_changed
                    action: input_boolean.turn_on
                  - target:
                      entity_id: "{{ climate_entity }}"
                    data:
                      target_temp_low: "{{ heat }}"
                      target_temp_high: "{{ cool }}"
                    action: climate.set_temperature
              - conditions:
                  - condition: template
                    value_template: "{{ current_mode == 'heat' }}"
                sequence:
                  - target:
                      entity_id: input_boolean.climate_downstairs_recently_changed
                    action: input_boolean.turn_on
                  - target:
                      entity_id: "{{ climate_entity }}"
                    data:
                      temperature: "{{ heat }}"
                    action: climate.set_temperature
              - conditions:
                  - condition: template
                    value_template: "{{ current_mode == 'cool' }}"
                sequence:
                  - target:
                      entity_id: input_boolean.climate_downstairs_recently_changed
                    action: input_boolean.turn_on
                  - target:
                      entity_id: "{{ climate_entity }}"
                    data:
                      temperature: "{{ cool }}"
                    action: climate.set_temperature
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ in_sleep_window }}"
                sequence:
                  - target:
                      entity_id: input_boolean.climate_downstairs_sleep
                    action: input_boolean.turn_on
                  - target:
                      entity_id:
                        - input_boolean.climate_downstairs_home
                        - input_boolean.climate_downstairs_away
                    action: input_boolean.turn_off
              - conditions:
                  - condition: template
                    value_template: "{{ not in_sleep_window }}"
                sequence:
                  - target:
                      entity_id: input_boolean.climate_downstairs_home
                    action: input_boolean.turn_on
                  - target:
                      entity_id:
                        - input_boolean.climate_downstairs_away
                        - input_boolean.climate_downstairs_sleep
                    action: input_boolean.turn_off
      - conditions:
          - condition: template
            value_template: "{{ not is_state('group.presence_all_home', 'home') }}"
        sequence:
          - variables:
              heat: "{{ setpoints.away.heat + adjust }}"
              cool: "{{ setpoints.away.cool + adjust }}"
              current_mode: "{{ states('climate.downstairs_2') }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ current_mode in ['auto', 'heat_cool'] }}"
                sequence:
                  - target:
                      entity_id: input_boolean.climate_downstairs_recently_changed
                    action: input_boolean.turn_on
                  - target:
                      entity_id: "{{ climate_entity }}"
                    data:
                      target_temp_low: "{{ heat }}"
                      target_temp_high: "{{ cool }}"
                    action: climate.set_temperature
              - conditions:
                  - condition: template
                    value_template: "{{ current_mode == 'heat' }}"
                sequence:
                  - target:
                      entity_id: input_boolean.climate_downstairs_recently_changed
                    action: input_boolean.turn_on
                  - target:
                      entity_id: "{{ climate_entity }}"
                    data:
                      temperature: "{{ heat }}"
                    action: climate.set_temperature
              - conditions:
                  - condition: template
                    value_template: "{{ current_mode == 'cool' }}"
                sequence:
                  - target:
                      entity_id: input_boolean.climate_downstairs_recently_changed
                    action: input_boolean.turn_on
                  - target:
                      entity_id: "{{ climate_entity }}"
                    data:
                      temperature: "{{ cool }}"
                    action: climate.set_temperature
          - target:
              entity_id: input_boolean.climate_downstairs_away
            action: input_boolean.turn_on
          - target:
              entity_id:
                - input_boolean.climate_downstairs_home
                - input_boolean.climate_downstairs_sleep
            action: input_boolean.turn_off
  - delay:
      hours: 0
      minutes: 0
      seconds: 10
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.climate_downstairs_recently_changed
  - data:
      title: Smart Climate Downstairs Debug
      message: >
        ðŸ§  **Smart Climate Debug Downstairs**


        **Triggered:** {{ now() }}

        **Trigger Source:** {{ trigger.entity_id if trigger.entity_id is defined
        else trigger.platform }}


        **Presence Home:** {{ states('group.presence_all_home') }}

        **Door Open:** {{ door_open }}

        **Occupied:** {{ is_state('binary_sensor.downstairs_motion_sensors',
        'on') }}

        **Outdoor Temp:** {{ outdoor_temp }}Â°F

        **Manual Override:** {{
        is_state('input_boolean.climate_downstairs_recently_changed','on') }}

        **Sleep Window:** {{ in_sleep_window }}


        ---

        **Adjustment Details**

        - Adjustment = {{ adjust }} ( +2 if outdoor <25Â°F, -2 if >85Â°F, else 0 )

        - Mode = {% if in_sleep_window %}Sleep{% elif
        is_state('group.presence_all_home','home') %}Home{% else %}Away{% endif
        %}

        - Occupancy = {% if
        is_state('binary_sensor.downstairs_motion_sensors','on') %}Occupied{%
        else %}Unoccupied{% endif %}


        ---

        **Setpoint Math**


        {% if in_sleep_window %}

        Sleep mode active â†’ Base Heat {{ setpoints.sleep.heat }}Â°F + Adj {{
        adjust }} â†’ **{{ setpoints.sleep.heat + adjust }}Â°F**

        Sleep mode active â†’ Base Cool {{ setpoints.sleep.cool }}Â°F + Adj {{
        adjust }} â†’ **{{ setpoints.sleep.cool + adjust }}Â°F**


        {% elif is_state('group.presence_all_home','home') %}
          {% if is_state('binary_sensor.bedroom_occupancy_2','on') or is_state('binary_sensor.kitchen_occupancy_4','on') %}
        Home & Occupied â†’ Base Heat {{ setpoints.home.heat }}Â°F + Adj {{ adjust
        }} â†’ **{{ setpoints.home.heat + adjust }}Â°F**

        Home & Occupied â†’ Base Cool {{ setpoints.home.cool }}Â°F + Adj {{ adjust
        }} â†’ **{{ setpoints.home.cool + adjust }}Â°F**
          {% else %}
        Home & Unoccupied â†’ Base Heat {{ setpoints.home.heat }}Â°F -3 + Adj {{
        adjust }} â†’ **{{ setpoints.home.heat - 3 + adjust }}Â°F**

        Home & Unoccupied â†’ Base Cool {{ setpoints.home.cool }}Â°F +3 + Adj {{
        adjust }} â†’ **{{ setpoints.home.cool + 3 + adjust }}Â°F**
          {% endif %}

        {% else %}

        Away mode â†’ Base Heat {{ setpoints.away.heat }}Â°F + Adj {{ adjust }} â†’
        **{{ setpoints.away.heat + adjust }}Â°F**

        Away mode â†’ Base Cool {{ setpoints.away.cool }}Â°F + Adj {{ adjust }} â†’
        **{{ setpoints.away.cool + adjust }}Â°F**

        {% endif %}


        ---

        **Final Setpoints**

        - Heat = {{ heat }}Â°F

        - Cool = {{ cool }}Â°F

        - HVAC Mode = {{ states('climate.downstairs_2') }}
    action: persistent_notification.create
    enabled: false
variables:
  climate_entity: climate.downstairs_2
  outdoor_temp: >-
    {{ states('sensor.weathersense_feels_like_temperature_outside') | float(0)
    }}
  door_open: "{{ is_state('binary_sensor.basementwindowsensors', 'on') }}"
  sleep_start: "19:30:00"
  sleep_end: "06:45:00"
  current_time: "{{ now().time() }}"
  sleep_start_time: "{{ strptime(sleep_start, '%H:%M:%S').time() }}"
  sleep_end_time: "{{ strptime(sleep_end, '%H:%M:%S').time() }}"
  in_sleep_window: |-
    {% if sleep_start_time <= sleep_end_time %}
      {{ sleep_start_time <= current_time <= sleep_end_time }}
    {% else %}
      {{ current_time >= sleep_start_time or current_time <= sleep_end_time }}
    {% endif %}
  adjust: "{{ 2 if outdoor_temp < 25 else -2 if outdoor_temp > 85 else 0 }}"
  setpoints:
    home:
      heat: 67
      cool: 78
    away:
      heat: 64
      cool: 79
    sleep:
      heat: 65
      cool: 72
mode: single
